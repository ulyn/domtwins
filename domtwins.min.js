"use strict";!function(a){"object"==typeof exports?module.exports=a(require("jquery")):"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function($){function reinitIframe(iframe,minHeight){var bHeight,dHeight,heightDeviation,height;try{bHeight=0,0==isChrome&&0==isSafari&&(bHeight=iframe.contentWindow.document.body.scrollHeight),dHeight=0,1==isFireFox?dHeight=iframe.contentWindow.document.documentElement.offsetHeight+2:0==isIE&&0==isOpera?dHeight=iframe.contentWindow.document.documentElement.scrollHeight:1==isIE&&isIE9More?(heightDeviation=bHeight-eval("window.IE9MoreRealHeight1"),0==heightDeviation?bHeight+=3:3!=heightDeviation&&(eval("window.IE9MoreRealHeight1="+bHeight),bHeight+=3)):bHeight+=3,height=Math.max(bHeight,dHeight),minHeight>height&&(height=minHeight),iframe.style.height=height+"px"}catch(ex){}}function removeIframe(a){for(var b=0;b<iframes.length;b++)if(iframes[b].iframe===a[0]){iframes.splice(b,1);break}a.remove()}function addIframeAutoCalcHeight(iframeDom,minHeight){0==iframes.length&&(eval("window.IE9MoreRealHeight1=0"),window.setInterval(function(){for(var a=0;a<iframes.length;a++)try{reinitIframe(iframes[a].iframe,iframes[a].minHeight)}catch(b){}},100)),minHeight=minHeight||1,iframes.push({iframe:iframe,minHeight:minHeight})}function open(a,b){History.open(this,a,"",b)}function _open(a,b,c){var d,e;a.onclose=c,d=$("iframe",a.iframeDom),d.attr("src")?(e=$("<iframe src='"+b+"' scrolling='no' frameborder='0' style='padding: 0px; width: 100%; height: 100%;'></iframe>"),d.after(e),removeIframe(d),0!=a.opts.iframeFit&&addIframeAutoCalcHeight(e[0])):d.attr("src",b),show(a,2)}function show(a,b){var c=a.selector;c.hide(),a.htmlLoaderDom.hide(),a.iframeDom.hide(),1==b?c.show():2==b?a.iframeDom.show():3==b&&a.htmlLoaderDom.show()}function openHtml(a,b){History.open(this,"",a,b)}function _openHtml(a,b,c){a.onclose=c,a.htmlLoaderDom.html(b),show(a,3)}function _close(domtwins,oncloseParams){if(show(domtwins,1),domtwins.onclose&&"string"==typeof domtwins.onclose){var onclose=domtwins.onclose;0==onclose.indexOf("___temp")?(domtwins.onclose=closeMethod[onclose],delete closeMethod[onclose]):domtwins.onclose=closeMethod[onclose]||eval(onclose)}domtwins.onclose&&"function"==typeof domtwins.onclose&&(domtwins.onclose(domtwins,oncloseParams),delete domtwins.onclose)}function close(a){History.back(this,a)}function onmessage(a){var c,d,e,b=a.data.type;if("close"===b)for(c in cache)try{if(d=cache[c].iframeDom.find("iframe")[0],d&&d.contentWindow==a.source){e=cache[c],e.close(a.data.data);break}}catch(a){Console.warn("异常",a)}}function DomTwins(a,b){var c,d;if(this.selector=a,this.opts=$.extend({iframeFit:!0,history:!1},b),History.load(this),c=this.selector.attr(DOM_TWINS_ID)){if(cache[c])throw new Error("不允许出现相同的dom-twins-id："+c)}else c="id_"+ ++id,this.selector.attr(DOM_TWINS_ID,c);this.id=c,this.htmlLoaderDom=a.clone(!0).removeAttr("id").removeAttr("dom-twins-id").attr("dom-twins-copy",this.id).empty().hide(),d=$("<iframe src='' scrolling='no' frameborder='0' style='padding: 0px; width: 100%; height: 100%;'></iframe>"),this.iframeDom=this.htmlLoaderDom.clone(!0).append(d),$(a).after(this.htmlLoaderDom).after(this.iframeDom),0!=this.opts.iframeFit&&addIframeAutoCalcHeight(d[0]),cache[c]=this}var browserVersion,isOpera,isFireFox,isChrome,isSafari,isIE,isIE9More,iframes,DOM_TWINS_ID,cache,id,closeMethod,Console,History,CacheOncloseCount;if(!$)throw new Error("缺少依赖的jQuery");return browserVersion=window.navigator.userAgent.toUpperCase(),isOpera=browserVersion.indexOf("OPERA")>-1?!0:!1,isFireFox=browserVersion.indexOf("FIREFOX")>-1?!0:!1,isChrome=browserVersion.indexOf("CHROME")>-1?!0:!1,isSafari=browserVersion.indexOf("SAFARI")>-1?!0:!1,isIE=!!window.ActiveXObject||"ActiveXObject"in window,isIE9More=0==!-[1],iframes=[],DOM_TWINS_ID="dom-twins-id",cache={},id=0,closeMethod={},Console={info:function(a,b){console&&console.info(a,b)},warn:function(a,b){console&&console.warn(a,b)}},History={load:function(a){a.opts.history=a.opts.history&&"pushState"in history,a.opts.history&&(this.historyDomtwins?(Console.warn("不允许多个有历史功能的domtwins,设置该对象history为false",a),a.opts.history=!1):(this.historyDomtwins=a,this.init()))},init:function(){var self=this;window.onpopstate=function(e){var url,domtwins_status,html,domtwins_id,onclose,domtwins,closeDoes;e.state&&(url=e.state.url,domtwins_status=e.state.domtwins_status,html=e.state.html,domtwins_id=e.state.domtwins_id,onclose=e.state.onclose,0===domtwins_status?domtwins_id&&cache[domtwins_id]&&(domtwins=cache[domtwins_id],show(domtwins,1),onclose&&"string"==typeof onclose&&(closeDoes=closeMethod[onclose]||eval(onclose),closeDoes&&"function"==typeof closeDoes&&closeDoes(domtwins,domtwins["_tmp_oncloseParams"]))):1===domtwins_status&&domtwins_id&&cache[domtwins_id]&&(url?show(cache[domtwins_id],2):show(cache[domtwins_id],3)))}},open:function(a,b,c,d){var e,f;a.opts.history&&(e="",f="#domtwins"+a.id,"function"==typeof d?(e="CacheOnclose_"+a.id,delete closeMethod[e],DomTwins.registerCloseMethod(e,d)):e=d,history.replaceState($.extend({},history.state,{domtwins_id:a.id,url:b,onclose:e,domtwins_status:0}),"",location.href),history.pushState({domtwins_id:a.id,opts:a.opts,url:b,onclose:e,domtwins_status:1},"",f)),b?_open(a,b,d):_openHtml(a,c,d)},back:function(a,b){this.historyDomtwins&&a.id===this.historyDomtwins.id&&"#domtwins"+a.id===location.hash?(a["_tmp_oncloseParams"]=b,history.back()):_close(a,b)}},"addEventListener"in document?window.addEventListener("message",onmessage,!1):"attachEvent"in document&&window.attachEvent("onmessage",onmessage),CacheOncloseCount=0,DomTwins.prototype={version:"1.0.5",open:open,openHtml:openHtml,close:close},DomTwins.closeThis=function(a){parent.postMessage({type:"close",data:a},"*")},DomTwins.parentClose=function(a,b){var d,e,f,c=a;"[object Window]"!=a.toString()&&(c=a.ownerDocument.defaultView),d="temp"+(new Date).getTime(),e=c.document,$("body",e).attr("dom-twins-body-rel",d),f=c.parent.document,$(f).find("iframe").each(function(){var e,f,a=$(this),c=$(this.contentWindow.document).find("body").attr("dom-twins-body-rel");c==d&&(e=a.parent().prev(),f=cache[e.attr(DOM_TWINS_ID)],f.close(b))})},DomTwins.registerCloseMethod=function(a,b){if("function"!=typeof b)throw new Error("入参func不是函数:"+b);if(closeMethod.hasOwnProperty(a))throw new Error("同名函数注册只能注册一次:"+a);closeMethod[a]=b},$.fn.DomTwins=function(a){var b=$(this),c=b.attr(DOM_TWINS_ID);return c?cache[c]||new DomTwins(b):new DomTwins(b,a)},$(document).on("click","[dom-twins-target]",function(){var e,f,a=$(this),b=a.attr("dom-twins-target"),c=$("["+DOM_TWINS_ID+"="+b+"]"),d=cache[b];return d||(e=a.attr("dom-twins-iframeFit")||a.attr("dom-twins-iframefit"),f=a.attr("dom-twins-history")||a.attr("dom-twins-history"),d=new DomTwins(c,{iframeFit:"true"===e||"1"===e,history:"true"===f||"1"===f})),d.open(a.attr("dom-twins-href"),a.attr("dom-twins-onclose")),!1}),window.DomTwins=DomTwins,DomTwins});